# NetworkPolicy Zero Trust - Deny All + Explicit Allow
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: secure-app-netpol
  namespace: production
  labels:
    app: secure-app
  annotations:
    policy.type: "zero-trust"
    security.compliance/level: "defense"
spec:
  podSelector:
    matchLabels:
      app: secure-app
  
  # Politique par défaut : DENY ALL
  policyTypes:
  - Ingress
  - Egress
  
  # Règles d'entrée explicites
  ingress:
  # Autoriser le trafic depuis l'ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    - podSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  
  # Autoriser le monitoring (Prometheus)
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    - podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8080
  
  # Règles de sortie explicites
  egress:
  # DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  
  # Accès à Vault pour secrets
  - to:
    - namespaceSelector:
        matchLabels:
          name: vault-system
    - podSelector:
        matchLabels:
          app: vault
    ports:
    - protocol: TCP
      port: 8200
  
  # Communication inter-pods de l'app
  - to:
    - podSelector:
        matchLabels:
          app: secure-app
    ports:
    - protocol: TCP
      port: 8080
  
  # Accès base de données (si applicable)
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    - podSelector:
        matchLabels:
          app: postgresql
    ports:
    - protocol: TCP
      port: 5432

---
# NetworkPolicy globale pour le namespace (défense en profondeur)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: production-default-deny
  namespace: production
  annotations:
    policy.type: "default-deny-all"
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  # Aucune règle = DENY ALL par défaut